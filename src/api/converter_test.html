<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DOCX íŒŒì¼ ë³€í™˜ê¸°</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }
      input[type="file"],
      select {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-right: 10px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        display: none;
      }
      .success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .loading {
        text-align: center;
        color: #007bff;
      }
      .supported-formats {
        background-color: #e7f3ff;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“„ DOCX íŒŒì¼ ë³€í™˜ê¸°</h1>

      <div class="supported-formats">
        <h3>ì§€ì›í•˜ëŠ” ë³€í™˜ í˜•ì‹</h3>
        <div id="supportedFormats">ë¡œë”© ì¤‘...</div>
      </div>

      <form id="convertForm">
        <div class="form-group">
          <label for="file">DOCX íŒŒì¼ ì„ íƒ:</label>
          <input
            type="file"
            id="file"
            name="file"
            accept=".docx,.doc"
            required
          />
        </div>

        <div class="form-group">
          <label for="outputFormat">ì¶œë ¥ í˜•ì‹:</label>
          <select id="outputFormat" name="outputFormat" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="txt">TXT</option>
            <option value="json">JSON</option>
            <option value="pdf">PDF</option>
          </select>
        </div>

        <div class="form-group">
          <label for="conversionType">ë³€í™˜ íƒ€ì…:</label>
          <select id="conversionType" name="conversionType">
            <option value="default">ê¸°ë³¸</option>
          </select>
        </div>

        <button type="button" onclick="convertFile()">
          íŒŒì¼ ë³€í™˜ ë° ë‹¤ìš´ë¡œë“œ
        </button>
        <button type="button" onclick="getConversionInfo()">
          ë³€í™˜ ì •ë³´ë§Œ í™•ì¸
        </button>
      </form>

      <div id="result" class="result"></div>
    </div>

    <script>
      // í˜„ì¬ í˜ì´ì§€ì˜ í˜¸ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ API URL ì„¤ì •
      const API_BASE_URL = window.location.origin;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ì› í˜•ì‹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      window.onload = async function () {
        await loadSupportedFormats();
      };

      async function loadSupportedFormats() {
        try {
          const response = await fetch(`${API_BASE_URL}/converter/formats`);
          const data = await response.json();

          const formatsDiv = document.getElementById("supportedFormats");
          let html = "<ul>";

          data.supported_formats.forEach((format) => {
            const types = data.conversion_types[format] || [];
            html += `<li><strong>${format.toUpperCase()}</strong>: ${types.join(
              ", "
            )}</li>`;
          });

          html += "</ul>";
          formatsDiv.innerHTML = html;

          // ì¶œë ¥ í˜•ì‹ ë³€ê²½ ì‹œ ë³€í™˜ íƒ€ì… ì—…ë°ì´íŠ¸
          document.getElementById("outputFormat").onchange = function () {
            updateConversionTypes(this.value, data.conversion_types);
          };
        } catch (error) {
          console.error("ì§€ì› í˜•ì‹ ë¡œë“œ ì‹¤íŒ¨:", error);
          document.getElementById("supportedFormats").innerHTML = "ë¡œë“œ ì‹¤íŒ¨";
        }
      }

      function updateConversionTypes(format, conversionTypes) {
        const conversionTypeSelect = document.getElementById("conversionType");
        conversionTypeSelect.innerHTML = "";

        if (format && conversionTypes[format]) {
          conversionTypes[format].forEach((type) => {
            const option = document.createElement("option");
            option.value = type;
            option.textContent = getTypeDisplayName(type);
            if (type === "default") option.selected = true;
            conversionTypeSelect.appendChild(option);
          });
        }
      }

      function getTypeDisplayName(type) {
        const names = {
          default: "ê¸°ë³¸",
          simple: "ê°„ë‹¨",
          detailed: "ìƒì„¸",
          formatted: "ì„œì‹ í¬í•¨",
        };
        return names[type] || type;
      }

      async function convertFile() {
        const fileInput = document.getElementById("file");
        const outputFormat = document.getElementById("outputFormat").value;
        const conversionType = document.getElementById("conversionType").value;

        if (!fileInput.files[0] || !outputFormat) {
          showResult("íŒŒì¼ê³¼ ì¶œë ¥ í˜•ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("output_format", outputFormat);
        formData.append("conversion_type", conversionType);

        showResult("íŒŒì¼ ë³€í™˜ ì¤‘...", "loading");

        try {
          const response = await fetch(`${API_BASE_URL}/converter/convert`, {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            const blob = await response.blob();

            // Content-Disposition í—¤ë”ì—ì„œ íŒŒì¼ëª… ì¶”ì¶œ
            let filename = `converted.${outputFormat}`;
            const contentDisposition = response.headers.get(
              "Content-Disposition"
            );
            if (contentDisposition) {
              const filenameMatch = contentDisposition.match(
                /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/
              );
              if (filenameMatch) {
                filename = filenameMatch[1];
              }
            }

            // íŒŒì¼ëª… ì •ë¦¬: ë”°ì˜´í‘œ ì œê±° ë° ë§¨ ì•ë’¤ ì–¸ë”ìŠ¤ì½”ì–´ ì œê±°
            filename = filename.replace(/['"]/g, ""); // ë”°ì˜´í‘œ ì œê±°
            filename = filename.replace(/^_+|_+$/g, ""); // ë§¨ ì•ê³¼ ë’¤ ì–¸ë”ìŠ¤ì½”ì–´ ì œê±°

            // í™•ì¥ìê°€ ì—†ëŠ” ê²½ìš° ì¶”ê°€
            if (!filename.includes(".")) {
              filename += `.${outputFormat}`;
            }

            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            const processingTime = response.headers.get("X-Processing-Time");
            const fileSize = response.headers.get("X-File-Size");

            showResult(
              `íŒŒì¼ ë³€í™˜ ì™„ë£Œ!\níŒŒì¼ëª…: ${filename}\níŒŒì¼ í¬ê¸°: ${formatFileSize(
                fileSize
              )}\nì²˜ë¦¬ ì‹œê°„: ${processingTime}ì´ˆ`,
              "success"
            );
          } else {
            const errorData = await response.json();
            showResult(`ë³€í™˜ ì‹¤íŒ¨: ${errorData.detail}`, "error");
          }
        } catch (error) {
          showResult(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, "error");
        }
      }

      async function getConversionInfo() {
        const fileInput = document.getElementById("file");
        const outputFormat = document.getElementById("outputFormat").value;
        const conversionType = document.getElementById("conversionType").value;

        if (!fileInput.files[0] || !outputFormat) {
          showResult("íŒŒì¼ê³¼ ì¶œë ¥ í˜•ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", "error");
          return;
        }

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("output_format", outputFormat);
        formData.append("conversion_type", conversionType);

        showResult("ë³€í™˜ ì •ë³´ í™•ì¸ ì¤‘...", "loading");

        try {
          const response = await fetch(
            `${API_BASE_URL}/converter/convert-info`,
            {
              method: "POST",
              body: formData,
            }
          );

          const data = await response.json();

          if (data.success) {
            showResult(
              `ë³€í™˜ ì •ë³´:\níŒŒì¼ëª…: ${
                data.filename
              }\níŒŒì¼ í¬ê¸°: ${formatFileSize(data.file_size)}\në³€í™˜ íƒ€ì…: ${
                data.conversion_type
              }\nì²˜ë¦¬ ì‹œê°„: ${data.processing_time.toFixed(2)}ì´ˆ`,
              "success"
            );
          } else {
            showResult(`ì •ë³´ í™•ì¸ ì‹¤íŒ¨: ${data.message}`, "error");
          }
        } catch (error) {
          showResult(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, "error");
        }
      }

      function showResult(message, type) {
        const resultDiv = document.getElementById("result");
        resultDiv.textContent = message;
        resultDiv.className = `result ${type}`;
        resultDiv.style.display = "block";
        resultDiv.style.whiteSpace = "pre-line";
      }

      function formatFileSize(bytes) {
        if (!bytes) return "N/A";
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return (
          Math.round((bytes / Math.pow(1024, i)) * 100) / 100 + " " + sizes[i]
        );
      }
    </script>
  </body>
</html>
